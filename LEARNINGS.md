# Learnings

Auto-generated by nightly compound review. Read by Claude Code at session start.

## 2026-02-14

### Patterns
- Wall of Wins testimonial section: auto-read tweet screenshots from `public/testimonials/` directory — just SCP a new image to the server to add testimonials, no code changes needed
- Tweet screenshot tools (PostSpark, etc.) as lightweight social proof capture — screenshot the tweet, upload to `public/testimonials/`, and it appears on the landing page automatically
- Trial countdown component on dashboard creates urgency without being aggressive — shows remaining days and a subtle upgrade CTA
- Conversion barrier audit across the full signup-to-upgrade funnel: identify every point where a user might bounce and remove friction (confusing pricing copy, hidden trial info, missing social proof)

### Gotchas
- Animated drill diagrams from FootballGPT port: only the code was displaying, not the rendered canvas — the drill parser and canvas renderer must both be correctly imported and the chat-config must trigger drill generation on the right message patterns
- SCP from local machine to VPS for testimonial images: Claude Code running on VPS cannot access the user's local filesystem — user must SCP files to the VPS first, then Claude can process them
- Team plan pricing was invisible to users — DOCs and potential team buyers couldn't find it because it wasn't surfaced on the pricing page or in upgrade flows

### Decisions
- Wall of Wins testimonial section shipped on landing page with auto-discovery of screenshot images
- Conversion barriers removed: trial countdown added to dashboard, upgrade modal copy improved, pricing page clarified
- Team plan visibility improved so DOCs and organisations can discover it exists

## 2026-02-13

### Patterns
- Gibbs Reflective Cycle as a Pro-only feature works across multiple products (RefereeGPT and CoachReflect) — the 6-stage structure maps naturally to any post-session reflection regardless of sport or role
- Typed chat starters with Pro badges and reflection type routing: surface different entry points (free reflection, Gibbs cycle, structured review) as distinct cards on the dashboard — users see the Pro value before they even start chatting
- `areas_to_improve` field in insight extraction: extending the AI's structured output to include improvement areas enriches the reflection record and feeds into longitudinal tracking
- RLS must be enabled on ALL tables including auxiliary ones like `badges` and `coaching_themes` — LLM-generated schemas routinely miss RLS on lookup/reference tables

### Gotchas
- E2E test auth handling: Playwright tests that assume redirect-based auth (expect redirect to /login) break on pages that are intentionally public — always verify the actual route's auth behaviour before writing test assertions
- 62 E2E tests required significant updates after feature additions — batch E2E test maintenance after a wave of feature work rather than letting tests drift incrementally, which makes failures harder to diagnose

### Decisions
- Gibbs Reflective Cycle shipped as Pro-only guided reflection with 6-stage prompting
- FirstPromoter affiliate tracking added to root layout for web attribution
- Error boundaries added at root and dashboard levels for graceful error handling
- RLS enabled on badges and coaching_themes tables to close security gaps
- E2E test suite restored to 62/62 passing with proper auth handling for public vs protected routes

## 2026-01-30

### Gotchas
- Supabase Security Advisor warnings must be addressed promptly — LLM-generated code often has RLS gaps
- Google Search Console "page with redirect" issues need redirect chain cleanup for proper indexing

## 2026-02-02

### Patterns
- Voice note limits split into short (<2min) and full (>2min) categories to enable generous free-tier micro-reflections while gating expensive long transcriptions behind Pro
- Email template functions must be registered in the sender's template map — having the React component alone isn't enough
- Feature flags in subscription config (structured_reflection, communication_analysis, etc.) give fine-grained tier control without code changes

### Gotchas
- Onboarding email cron failed with "Unknown template" because social-proof, first-value, feature-highlight, and last-chance components existed but weren't wired into the email sender's dispatch map
- `cannot change return type of existing function` in Supabase — must DROP and recreate the function rather than ALTER when return type changes
- Admin console had broken joins and N+1 queries that only surfaced under real data — test admin pages with populated databases

### Decisions
- Three-tier pricing (Free / Pro / Pro Plus) with voice notes as the key differentiator between tiers
- Short voice notes (under 2 min) unlimited on Pro, full session recordings (60-90 min) on Pro Plus only due to transcription costs
- Voice analysis for coaching quality (communication patterns, development blocks, CPD export) positioned as Pro Plus features
- New feature branch created to protect current user testing while building voice analysis features

## 2026-02-03

### Patterns
- Mobile scroll jank fix: use a single scroll container (h-[100dvh] flex-col overflow-hidden) with header/nav as shrink-0 overlays — never nest competing scrollable regions
- Consistent AI markdown formatting requires explicit system prompt instructions enforcing bold headings and bullet lists as a minimum baseline
- Visual warmth in AI chat: warm colour palette (amber/stone accents), emoji selectors, and trailing question prompts make the experience feel less robotic

### Gotchas
- Trailing AI questions ("Would you like me to continue?") blend into the answer body — visually separating them with a divider and accent styling makes the next step obvious
- Chat input padding on mobile wastes significant screen real estate — compact single-row textarea with tighter padding reclaims usable space

## 2026-02-04

### Patterns
- Capacitor 8 uses Swift Package Manager (SPM) instead of CocoaPods — Codemagic build scripts must skip workspace/pod steps and build the .xcodeproj directly
- RevenueCat setup requires three layers: entitlements (access level), products (App Store/Play Store items), and offerings (what users see) — configure entitlements first, then products, then wire into offerings
- Chunked transcription for large audio files: split recordings into segments to stay within API limits for 90+ minute coaching session recordings
- Mobile app submission checklist: delete-account URL, privacy policy URL, data safety declarations, and subscription descriptions must all be live before store review

### Gotchas
- iOS bundle ID mismatch between Capacitor config and Codemagic signing causes build failures — hardcode the bundle ID in both places and verify they match (`com.coachreflection.app` not `com.coachreflect.app`)
- Codemagic auto-increment build number must be configured explicitly — iOS rejects duplicate build numbers on resubmission. Use `agvtool new-version -all $((${PROJECT_BUILD_NUMBER} + 1))` in codemagic.yaml
- Google Play requires a service account credentials JSON for RevenueCat server-side receipt validation — this is separate from the Play Console login
- App Store "404 on URL" rejection: the delete-account and privacy policy pages must be deployed and publicly accessible before submission, not just committed to the repo
- Provisioning profile must be manually created at developer.apple.com/account/resources/profiles if Codemagic `--create` flag doesn't auto-generate it
- DEVELOPMENT_TEAM (22F5XZJVF6) must be set in project.pbxproj for both Debug and Release build configurations — without it, Codemagic signing fails
- Default Capacitor app icon is a blue X placeholder — must replace AppIcon-512@2x.png (1024x1024, no alpha) before submission
- NativeHidden component MUST use useEffect pattern (not render-path check) to avoid React hydration mismatches on iOS WKWebView — lesson from FootballGPT Sentry errors
- Whisper API 25MB file limit means 90+ min session recordings silently fail transcription — chunked transcription with ffmpeg-static splits into 10-min segments
- Coach tester feedback: "nothing saved" when using voice note — likely mic permission denied or navigated away before clicking Stop Recording

### Decisions
- CoachReflection mobile apps set up via Capacitor + Codemagic + RevenueCat — same stack as FootballGPT for consistency
- Four email parity features added to match FootballGPT standard: abandoned checkout recovery, streak-at-risk reminder, winback day-7 final email, Resend webhook tracking
- Pro and Pro Plus subscriptions configured in RevenueCat with matching entitlements for cross-platform subscription management
- Full session recording upload (record on phone, upload to app) is the recommended path for 90+ min recordings — in-app recording not viable for long sessions due to browser/WebView constraints
- App Store listing positioned as multi-sport (not just football) to broaden addressable market

## 2026-02-05

### Patterns
- Cross-product SEO batch: llms.txt, AI keyword meta tags, custom 404 pages, and blog internal links can be templated and rolled out across all products in one session
- Topic pages (e.g. /topics/rugby, /topics/cricket) create SEO landing pages for each sport vertical without needing unique content per page — auto-generated from blog tag taxonomy
- App Store In-App Purchase configuration must be completed before submission even if the app uses Stripe for web — Apple requires IAP metadata to be present for review

### Gotchas
- App Store review requires at least one screenshot per device size AND app previews are separate from screenshots — "5 of 10 Screenshots" means 5 uploaded across two device sizes, not 5 of a required 10
- App Store Connect subscription setup can fail silently with "changes could not be saved" — retry later rather than re-creating, as the backend is eventually consistent
- Multi-sport positioning requires careful language audit — initial App Store copy was too football-focused despite the app supporting all sports

### Decisions
- CoachReflection submitted to App Store review — first submission with CR brand icon, multi-sport positioning, and IAP subscriptions configured
- SEO overhaul: added robots.ts, expanded sitemap, created /topics taxonomy pages, and added llms.txt for AI crawler discovery
- Blog posts now include internal links section ("Explore CoachReflection") to improve crawl depth and reduce bounce rate

## 2026-02-06

### Patterns
- Sport-specific SEO landing pages (/soccer-reflection, /football-reflection, /coaching-reflection-basketball, etc.) target different search intents with the same product — each page is a unique entry point for a different audience
- Native form POST handling: when JS hasn't hydrated yet on mobile (WKWebView), forms submit as traditional POST requests — the auth pages must handle both client-side and server-side form submissions
- Google OAuth doesn't work in WKWebView (Capacitor iOS/Android) — hide the OAuth button on native and show a guidance message directing users to set a password instead

### Gotchas
- App Store resubmission requires incrementing the build number (e.g. 11 → 12) even for the same version — duplicate build numbers are rejected without a clear error
- App Store Connect screenshot upload has no file picker if locale isn't saved first — the UI shows no upload controls, which looks like a bug but is actually a missing locale issue (same lesson as FootballGPT today)
- "soccer reflection" is a ranking keyword opportunity — US users search "soccer" not "football", so dedicated /soccer-reflection page captures that traffic separately from /football-reflection

### Decisions
- Sport-specific SEO pages created for basketball, cricket, tennis, soccer, and football — plus CPD coaching log page targeting coach education searches
- Blog content expanded with 4 new posts targeting long-tail keywords: session reflection how-to, CPD requirements, Gibbs cycle template, voice notes vs written journals
- YouTube SEO titles and descriptions document created for future video content planning
- Google OAuth hidden on native apps with password setup guidance — cleaner UX than showing a button that fails

## 2026-02-12

### Patterns
- Apple App Store rejection for Stripe checkout on iOS: native apps MUST use in-app purchase (RevenueCat) not web checkout — Apple rejects any build that routes to an external payment processor on iOS
- Platform detection for payment routing: check `Capacitor.isNativePlatform()` in upgrade modal to route iOS/Android to RevenueCat IAP and web to Stripe checkout — single component, two payment flows
- Admin user search must search auth emails (via `supabase.auth.admin.listUsers()`), not just profiles table — many users have NULL display names (especially Google OAuth), so name-only search misses them
- Supabase `auth.admin.listUsers()` defaults to 50 users per page — pass `perPage: 1000` to fetch all users, otherwise admin search silently returns incomplete results

### Gotchas
- Google OAuth users often have NULL `display_name` in profiles because the signup trigger wasn't extracting `name` or `full_name` from the OAuth metadata — fix the trigger AND backfill existing NULLs
- Admin interface showing user_id but not email is useless for support — admin search and display must always include the email from auth, not just profile fields
- "I don't want to do things manually" — when building admin tools, make them self-service from the start. Don't ship admin pages that require SQL to complete common tasks like looking up a user or changing a subscription

### Decisions
- RevenueCat IAP integrated for iOS/Android upgrade flow, Stripe retained for web — Apple compliance without losing web payment flexibility
- FirstPromoter `fp_tid` cookie passed through Stripe checkout metadata for affiliate attribution on web purchases
- Admin user search rebuilt to query auth emails first, then match against profiles — works for both email and name searches
- Signup trigger updated to extract display_name from Google OAuth metadata with backfill migration for existing NULL values

## 2026-02-11

### Patterns
- Animated drill diagrams ported from FootballGPT to CoachReflect: copy the drill-parser, drill-schema, and canvas renderer, then adapt the chat-config to trigger drill generation on coaching conversation context — reuse beats rebuild
- RevenueCat webhook must distinguish `period_type: TRIAL` on `INITIAL_PURCHASE` events — hardcoding `subscription_status = 'active'` skips the trial state and breaks the subscription gate for mobile trial users
- Trial nurture email sequence (welcome → value demo → social proof → last chance → trial ending) must be wired into both Stripe webhooks AND the email cron — Stripe triggers the start, the cron sends the drip sequence
- Free tier message limit was hardcoded to 5 in the chat route despite `LIMITS.FREE.messagesPerDay` being 2 — always derive limits from the config constant, never hardcode in route handlers

### Gotchas
- Supabase `subscription_status` constraint needed `trialing` added — the CHECK constraint blocked webhook updates from setting the trial status, causing silent save failures
- Post-checkout success banner wasn't showing because the redirect URL had `?success=true` but the page wasn't reading the param — always test the full checkout → redirect → success flow end-to-end
- Admin notification emails should distinguish trial start vs paid conversion vs cancellation — a single "new subscriber" email for all three events makes it impossible to track funnel health
- RLS on `generated_drills` table was missing — any authenticated user could read all drills including other users' private ones

### Decisions
- Animated drill library added to CoachReflect with pitch diagram canvas renderer from FootballGPT
- 7-day Stripe trial with card upfront added, matching the pattern across all products
- Free tier enforced at 2 messages/day (was incorrectly allowing 5)
- Trial-aware email sequence shipped with separate admin notifications per funnel stage

## 2026-02-10

### Patterns
- Hormozi Value Equation applied cross-product: rewrite every user-facing touchpoint to sell the OUTCOME (become a better coach, catch burnout early) instead of the PROCESS (reflect, journal, prompts) — outcome language converts better than feature lists
- Risk reversal (7-day free trial mention) at every upgrade decision point reduces perceived risk — users need to see the safety net right where they make the decision, not just on the pricing page
- Social proof at the paywall (e.g. "Join 500+ coaches") adds conversion pressure at the exact moment of hesitation

### Gotchas
- SEO page titles had "Coach Reflection" doubled (e.g. "Football Reflection | Coach Reflection | Coach Reflection") — meta tag templates that append the brand name must check whether the page title already includes it
- Apple App Store review feedback must be acted on promptly — delays can lead to the app being removed from the queue and requiring resubmission

### Decisions
- All user-facing copy rewritten with outcome-led language across landing page, upgrade modal, pricing, chat empty state, dashboard, history gate, settings, billing, FCA page, welcome email, and config tagline
- Meta tags fixed to prevent double brand name in SEO page titles

## 2026-02-09

### Gotchas
- `NEXT_PUBLIC_APP_URL` in Vercel had a trailing `\n` character that made Stripe checkout `success_url` invalid — env vars copied from terminals or config files can include invisible whitespace. When Stripe checkout fails silently, check the raw env var value first
- Hardcoding the app URL as a temporary fix is acceptable when env var corruption is the root cause — but document it and add a TODO to fix the env var at source

## 2026-02-08

### Patterns
- Stripe checkout success/cancel URLs should fall back to `request.headers.get('origin')` when `NEXT_PUBLIC_APP_URL` is missing or empty — prevents blank page on redirect when env var isn't set
- Stripe checkout from client-side fetch must return JSON with the checkout URL, not a 303 redirect — fetch follows redirects internally and the browser never navigates. Return `{ url }` and let the client do `window.location.href = url`
- Share-a-summary feature (generate shareable coaching reflection cards) creates social proof and organic discovery — users post their growth, non-users see the product
- FCA cross-promotion page (`/fca`) inside the product creates a natural upsell path to the coaching community without feeling like an ad

### Gotchas
- Stripe checkout returning 303 redirect to a fetch() caller results in a blank page — the browser's fetch API follows the redirect silently, receives the Stripe HTML page as the response body, and never navigates. Must detect JSON-capable callers (Accept header or content-type check) and return the URL as JSON instead
- `NEXT_PUBLIC_APP_URL` env var can be unset, empty string, or have trailing whitespace — all cause Stripe checkout to redirect to invalid URLs. Trim and validate before use, fall back to request origin
- RevenueCat webhook idempotency needs an in-memory or Redis set of processed event IDs — without it, webhook retries create duplicate subscription records
- Supabase auth `emailRedirectTo` must include the full URL with protocol — relative paths silently fail and users get "invalid request method" errors on the callback
- Stripe checkout blank page is one of the hardest bugs to debug because there's no error — the page loads, the fetch completes successfully (200), but the user sees nothing. The fix is architectural (JSON response vs redirect), not a simple parameter change

### Decisions
- Security hardening: HTML escaping in emails, webhook idempotency, admin client consolidation, rate-limit error logging upgraded
- Conversion funnel rebuilt: upgrade modals, limit enforcement, share-summary feature, /fca cross-promotion page, history upgrade banner
- Stripe checkout pattern aligned with FootballGPT's working implementation — JSON URL response for fetch callers, with origin fallback for success/cancel URLs
